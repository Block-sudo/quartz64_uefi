name: build

on:
  push:
  pull_request:
  workflow_dispatch:    # 手动运行

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # 必须要有这个才能上传 Release
    steps:
    - uses: actions/checkout@v4

    - name: Install toolchain
      run: |
        sudo apt update
        sudo apt install -y gcc-aarch64-linux-gnu iasl device-tree-compiler python3-pyelftools

    - name: Build
      run: |
        make sdcard

    # 把生成的固件打包
    - name: Archive firmware
      run: |
        mkdir -p output
        cp *.img *.bin output/ 2>/dev/null || true
        zip output/firmware.zip output/*

    # 上传到 GitHub Release
    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
      with:
        files: output/firmware.zip
        name: "Auto Build ${{ github.sha }}"
        body: "自动构建固件，来自 commit ${{ github.sha }}"
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
